# ğŸ“± Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ú†Øª - Ø¯Ùˆ Ù…Ø§Ú˜ÙˆÙ„ Ø¬Ø¯Ø§

## ğŸ“‹ ÙÙ‡Ø±Ø³Øª Ù…Ø·Ø§Ù„Ø¨

1. [Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ù„ÛŒ](#Ù…Ø¹Ù…Ø§Ø±ÛŒ-Ú©Ù„ÛŒ)
2. [Ø¨Ø®Ø´ Ø§ÙˆÙ„: Internal Chat](#Ø¨Ø®Ø´-Ø§ÙˆÙ„-internal-chat)
3. [Ø¨Ø®Ø´ Ø¯ÙˆÙ…: Support Chat](#Ø¨Ø®Ø´-Ø¯ÙˆÙ…-support-chat)
4. [ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ](#ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ÛŒ-Ú©Ù„ÛŒØ¯ÛŒ)
5. [Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯](#Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ-Ø¯Ø±-Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯)
6. [API Routes](#api-routes)
7. [Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ](#Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ-Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ)

---

## ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ù„ÛŒ

Ø³ÛŒØ³ØªÙ… Ú†Øª Ø´Ù…Ø§ Ø¨Ù‡ **Ø¯Ùˆ Ù…Ø§Ú˜ÙˆÙ„ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¬Ø¯Ø§** ØªÙ‚Ø³ÛŒÙ… Ø´Ø¯Ù‡ Ø§Ø³Øª:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ahromCrm System                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¢ Internal Chat    â”‚   â”‚  ğŸ« Support Chat     â”‚   â”‚
â”‚  â”‚  (Ú†Øª Ø¯Ø±ÙˆÙ† Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ)   â”‚   â”‚  (Ú†Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ)      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ âœ… ÙÙ‚Ø· Adminâ€ŒÙ‡Ø§       â”‚   â”‚ âœ… Admin + Ù…Ø´ØªØ±ÛŒØ§Ù†   â”‚   â”‚
â”‚  â”‚ âœ… WorkspaceUser      â”‚   â”‚ âœ… Guest + User       â”‚   â”‚
â”‚  â”‚ âœ… Team/Project       â”‚   â”‚ âœ… Ticket-based      â”‚   â”‚
â”‚  â”‚ âœ… Real-time         â”‚   â”‚ âœ… SLA & Priority     â”‚   â”‚
â”‚  â”‚ âœ… Ù…Ù†Ø§Ø¨Ø¹ (Docs...)   â”‚   â”‚ âœ… ØªØ®ØµÛŒØµ Ø¨Ù‡ ØªÛŒÙ…       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Admin:                                         â”‚
â”‚  /dashboard/chat         â†’ Internal Chat                â”‚
â”‚  /dashboard/support      â†’ Support Tickets              â”‚
â”‚                                                          â”‚
â”‚  Ø³Ø§ÛŒØª Ø¹Ù…ÙˆÙ…ÛŒ:                                            â”‚
â”‚  /[slug]/support         â†’ Support Chat (Guest)         â”‚
â”‚                                                          â”‚
â”‚  Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ:                                            â”‚
â”‚  /panel                  â†’ (Ø¯Ú©Ù…Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ)              â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¢ Ø¨Ø®Ø´ Ø§ÙˆÙ„: Internal Chat

### ğŸ¯ Ù‡Ø¯Ù

Ú¯ÙØªÚ¯ÙˆÛŒ **Ø¯Ø±ÙˆÙ† Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ** Ø¨ÛŒÙ† Ø§Ø¹Ø¶Ø§ÛŒ ØªÛŒÙ…ØŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ùˆ ÙˆØ¸Ø§ÛŒÙ.

### ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

ÙÙ‚Ø· **WorkspaceUser** Ø¨Ø§ Ù†Ù‚Ø´ **Admin**.

### ğŸ“Š Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ

#### 1. ChatRoom (Ø§ØªØ§Ù‚ Ú¯ÙØªÚ¯Ùˆ)

```prisma
model ChatRoom {
  id          Int      @id @default(autoincrement())
  workspaceId Int

  type        InternalChatRoomType  // DIRECT, TEAM, GROUP, PROJECT
  title       String?
  description String?
  icon        String?

  // Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…ÙˆØ¬ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
  teamId      Int?
  team        Team?
  projectId   Int?
  project     Project?

  // ØªÙ†Ø¸ÛŒÙ…Ø§Øª
  isPrivate   Boolean   @default(false)
  isArchived  Boolean   @default(false)
  isLocked    Boolean   @default(false)

  // Ø±ÙˆØ§Ø¨Ø·
  members     ChatRoomMember[]
  messages    ChatMessage[]

  // Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ù…Ù†Ø§Ø¨Ø¹
  linkedDocuments  ChatRoomDocument[]
  linkedTasks      ChatRoomTask[]
  linkedKnowledge  ChatRoomKnowledge[]
}
```

**Ø§Ù†ÙˆØ§Ø¹ Ø§ØªØ§Ù‚:**

- `DIRECT`: Ú¯ÙØªÚ¯ÙˆÛŒ Ø®ØµÙˆØµÛŒ 1-1
- `TEAM`: Ø§ØªØ§Ù‚ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªÛŒÙ…
- `GROUP`: Ú¯Ø±ÙˆÙ‡ Ø¯Ø³ØªÛŒ
- `PROJECT`: Ø§ØªØ§Ù‚ Ù¾Ø±ÙˆÚ˜Ù‡

#### 2. ChatRoomMember (Ø§Ø¹Ø¶Ø§ÛŒ Ø§ØªØ§Ù‚)

```prisma
model ChatRoomMember {
  roomId          Int
  workspaceUserId Int
  role            ChatRoomMemberRole  // OWNER, ADMIN, MODERATOR, MEMBER, GUEST

  // ÙˆØ¶Ø¹ÛŒØª Ø®ÙˆØ§Ù†Ø¯Ù†
  lastReadAt      DateTime?
  lastReadMessageId Int?

  // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ø®ØµÛŒ
  isMuted         Boolean
  customNickname  String?
  customColor     String?
}
```

#### 3. ChatMessage (Ù¾ÛŒØ§Ù…)

```prisma
model ChatMessage {
  roomId      Int
  senderId    Int

  body        String
  messageType ChatMessageType  // TEXT, IMAGE, FILE, VOICE, VIDEO, SYSTEM

  // Thread
  replyToId   Int?

  // Ø¶Ù…ÛŒÙ…Ù‡â€ŒÙ‡Ø§
  attachments Json?
  mentions    Json?  // [@userId1, @userId2]

  // ÙˆÛŒØ±Ø§ÛŒØ´/Ø­Ø°Ù
  isEdited    Boolean
  isDeleted   Boolean

  // Ù¾ÛŒÙ†
  isPinned    Boolean
}
```

### ğŸ¨ UI Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯

```
/dashboard/chat
â”œâ”€â”€ Sidebar (Ù„ÛŒØ³Øª Ø§ØªØ§Ù‚â€ŒÙ‡Ø§)
â”‚   â”œâ”€â”€ Direct Messages
â”‚   â”œâ”€â”€ Team Rooms
â”‚   â”œâ”€â”€ Project Rooms
â”‚   â””â”€â”€ Groups
â”‚
â””â”€â”€ Main Area
    â”œâ”€â”€ Header
    â”‚   â”œâ”€â”€ Room Title
    â”‚   â””â”€â”€ Tabs: [ğŸ’¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§] [ğŸ“„ Ø§Ø³Ù†Ø§Ø¯] [ğŸ“š Ø¯Ø§Ù†Ø´] [âœ… ÙˆØ¸Ø§ÛŒÙ]
    â”‚
    â”œâ”€â”€ Messages Area
    â”‚   â””â”€â”€ (Ø¨Ø³ØªÙ‡ Ø¨Ù‡ ØªØ¨ ÙØ¹Ø§Ù„)
    â”‚
    â””â”€â”€ Input
```

### ğŸ’» Ù…Ø«Ø§Ù„ Ú©Ø¯: Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ ØªÛŒÙ…ÛŒ

```typescript
// services/InternalChatService.ts
async function createTeamRoom(teamId: number, workspaceId: number) {
  const team = await prisma.team.findUnique({
    where: { id: teamId },
    include: { members: true },
  });

  return prisma.$transaction(async (tx) => {
    // 1. Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚
    const room = await tx.chatRoom.create({
      data: {
        type: "TEAM",
        title: `ØªÛŒÙ… ${team.name}`,
        teamId,
        workspaceId,
        createdById: team.members[0].workspaceUserId,
      },
    });

    // 2. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¶Ø§
    await tx.chatRoomMember.createMany({
      data: team.members.map((m) => ({
        roomId: room.id,
        workspaceUserId: m.workspaceUserId,
        role: "MEMBER",
      })),
    });

    // 3. Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
    await tx.chatMessage.create({
      data: {
        roomId: room.id,
        senderId: team.members[0].workspaceUserId,
        body: `Ú¯Ø±ÙˆÙ‡ ${team.name} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`,
        messageType: "SYSTEM",
      },
    });

    return room;
  });
}
```

---

## ğŸ« Ø¨Ø®Ø´ Ø¯ÙˆÙ…: Support Chat

### ğŸ¯ Ù‡Ø¯Ù

Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² **Ù…Ø´ØªØ±ÛŒØ§Ù†** (Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ ÛŒØ§ Ù…Ù‡Ù…Ø§Ù†) ØªÙˆØ³Ø· **ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ**.

### ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

- **Ù…Ø´ØªØ±ÛŒØ§Ù†**: Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ù‡Ù…Ø§Ù† (Ø¨Ø¯ÙˆÙ† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…) ÛŒØ§ WorkspaceUser Ø¨Ø§ Ù†Ù‚Ø´ User
- **Ù¾Ø´ØªÛŒØ¨Ø§Ù†Ø§Ù†**: WorkspaceUser Ø¨Ø§ Ù†Ù‚Ø´ Admin (Ø¹Ø¶Ùˆ ØªÛŒÙ… Support)

### ğŸ“Š Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ

#### 1. SupportGuestUser (Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†)

```prisma
model SupportGuestUser {
  workspaceId Int

  // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡
  ipAddress   String    // 192.168.1.1 ÛŒØ§ IPv6
  country     String?   // "Iran"
  city        String?   // "Tehran"
  userAgent   String?
  browser     String?   // "Chrome 120"
  os          String?   // "Windows 11"
  device      String?   // "desktop" | "mobile" | "tablet"

  // Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
  email       String?
  name        String?
  phone       String?

  // Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ
  fingerprint String?   // Browser fingerprint
  sessionId   String?

  // Ø¢Ù…Ø§Ø±
  firstVisitAt DateTime
  lastVisitAt  DateTime
  visitCount   Int

  // Ø±ÙˆØ§Ø¨Ø·
  tickets     SupportTicket[]
  messages    SupportMessage[]
}
```

**Ú†Ø±Ø§ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§ØªØŸ**
âœ… Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¨Ø§Ø²Ø¯ÛŒØ¯Ù‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ  
âœ… Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² spam  
âœ… Ø¢Ù…Ø§Ø± Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ  
âœ… Ø¨Ù‡Ø¨ÙˆØ¯ UX (Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø²Ø¨Ø§Ù† Ú©Ø§Ø±Ø¨Ø±)

#### 2. SupportTicket (ØªÛŒÚ©Øª)

```prisma
model SupportTicket {
  workspaceId Int

  ticketNumber String   // "TKT-2024-00001"

  // Ú©Ø§Ø±Ø¨Ø± (ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ùˆ)
  guestUserId     Int?
  workspaceUserId Int?

  // Ø§Ø·Ù„Ø§Ø¹Ø§Øª
  subject     String
  description String?

  // ÙˆØ¶Ø¹ÛŒØª
  status      SupportTicketStatus   // OPEN, IN_PROGRESS, WAITING, RESOLVED, CLOSED
  priority    SupportPriority       // LOW, MEDIUM, HIGH, URGENT, CRITICAL

  // ØªØ®ØµÛŒØµ
  assignedToId   Int?    // Ù¾Ø´ØªÛŒØ¨Ø§Ù†
  assignedTeamId Int?    // ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ

  // SLA
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  responseTime    Int?      // Ø«Ø§Ù†ÛŒÙ‡
  resolutionTime  Int?      // Ø«Ø§Ù†ÛŒÙ‡

  // Ø±ÙˆØ§Ø¨Ø·
  messages    SupportMessage[]
  labels      SupportTicketLabel[]
  history     SupportTicketHistory[]

  // Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ù…Ù†Ø§Ø¨Ø¹
  linkedTasks     SupportTicketTask[]
  linkedDocuments SupportTicketDocument[]
  linkedKnowledge SupportTicketKnowledge[]
}
```

#### 3. SupportMessage (Ù¾ÛŒØ§Ù… ØªÛŒÚ©Øª)

```prisma
model SupportMessage {
  ticketId Int

  // ÙØ±Ø³ØªÙ†Ø¯Ù‡ (ÛŒÚ©ÛŒ Ø§Ø² Ø³Ù‡)
  supportAgentId  Int?   // Ù¾Ø´ØªÛŒØ¨Ø§Ù†
  guestUserId     Int?   // Ù…Ù‡Ù…Ø§Ù†
  workspaceUserId Int?   // Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡

  body        String
  messageType SupportMessageType  // TEXT, IMAGE, FILE, SYSTEM, NOTE

  // Ø¯Ø³ØªØ±Ø³ÛŒ
  isInternal  Boolean  // âœ… Ú©Ù„ÛŒØ¯ÛŒ: ÙÙ‚Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯
  isVisible   Boolean

  // ÙˆØ¶Ø¹ÛŒØª
  isRead      Boolean
  readAt      DateTime?
}
```

**Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ (Internal Notes):**

```typescript
// Ù¾Ø´ØªÛŒØ¨Ø§Ù† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø®ØµÙˆØµÛŒ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ø¯
await prisma.supportMessage.create({
  data: {
    ticketId: 123,
    supportAgentId: 10,
    body: "Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ù‡Ù… Ù…Ø´Ú©Ù„ Ù…Ø´Ø§Ø¨Ù‡ Ø¯Ø§Ø´ØªÙ‡",
    messageType: "NOTE",
    isInternal: true, // âœ… Ù…Ø´ØªØ±ÛŒ Ù†Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ø¯
    isVisible: false,
  },
});
```

### ğŸ¨ UI Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯

#### Ø¨Ø±Ø§ÛŒ Admin (ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ):

```
/dashboard/support
â”œâ”€â”€ Sidebar
â”‚   â”œâ”€â”€ Stats
â”‚   â”‚   â”œâ”€â”€ Open: 12
â”‚   â”‚   â”œâ”€â”€ In Progress: 5
â”‚   â”‚   â””â”€â”€ Today: 8
â”‚   â”‚
â”‚   â”œâ”€â”€ Filters
â”‚   â”‚   â”œâ”€â”€ ÙˆØ¶Ø¹ÛŒØª
â”‚   â”‚   â”œâ”€â”€ Ø§ÙˆÙ„ÙˆÛŒØª
â”‚   â”‚   â”œâ”€â”€ ØªØ®ØµÛŒØµ Ø´Ø¯Ù‡ Ø¨Ù‡ Ù…Ù†
â”‚   â”‚   â””â”€â”€ ØªØ®ØµÛŒØµ Ù†Ø´Ø¯Ù‡
â”‚   â”‚
â”‚   â””â”€â”€ Ticket List
â”‚
â””â”€â”€ Main Area
    â”œâ”€â”€ Ticket Header
    â”‚   â”œâ”€â”€ #TKT-2024-00001
    â”‚   â”œâ”€â”€ Subject
    â”‚   â”œâ”€â”€ Status Badge
    â”‚   â”œâ”€â”€ Priority Badge
    â”‚   â””â”€â”€ Actions (ØªØ®ØµÛŒØµØŒ Ø¨Ø³ØªÙ†ØŒ ...)
    â”‚
    â”œâ”€â”€ Customer Info
    â”‚   â”œâ”€â”€ Ù†Ø§Ù…/Ø§ÛŒÙ…ÛŒÙ„
    â”‚   â”œâ”€â”€ IP: 192.168.1.1
    â”‚   â”œâ”€â”€ Ú©Ø´ÙˆØ±: Iran
    â”‚   â”œâ”€â”€ Browser: Chrome
    â”‚   â””â”€â”€ Ø¨Ø§Ø²Ø¯ÛŒØ¯: 3 Ø¨Ø§Ø±
    â”‚
    â”œâ”€â”€ Messages
    â”‚   â”œâ”€â”€ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ (Ø³Ù…Øª Ú†Ù¾)
    â”‚   â”œâ”€â”€ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ø³Ù…Øª Ø±Ø§Ø³Øª)
    â”‚   â””â”€â”€ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ (Ø¨Ø§ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø²Ø±Ø¯)
    â”‚
    â”œâ”€â”€ Linked Resources
    â”‚   â”œâ”€â”€ ÙˆØ¸Ø§ÛŒÙ Ù…Ø±ØªØ¨Ø·
    â”‚   â”œâ”€â”€ Ø§Ø³Ù†Ø§Ø¯ Ù…Ø±ØªØ¨Ø·
    â”‚   â””â”€â”€ Ø¯Ø§Ù†Ø´ Ù…Ø±ØªØ¨Ø·
    â”‚
    â””â”€â”€ Input
        â”œâ”€â”€ [ğŸ’¬ Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ] [ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø®ØµÙˆØµÛŒ]
        â””â”€â”€ [ğŸ“ Ø¶Ù…ÛŒÙ…Ù‡] [ğŸ”— Ù„ÛŒÙ†Ú© Ù…Ù†Ø§Ø¨Ø¹]
```

#### Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ (Guest/User):

```
/[slug]/support  ÛŒØ§  /panel (Ø¯Ú©Ù…Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ« Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ØªÛŒÚ©Øª: TKT-2024-00001              â”‚
â”‚  ÙˆØ¶Ø¹ÛŒØª: Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§]                         â”‚
â”‚                                    â”‚
â”‚  Ø´Ù…Ø§: Ø³Ù„Ø§Ù… Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù…Ú© Ø¯Ø§Ø±Ù…        â”‚
â”‚  10:30                             â”‚
â”‚                                    â”‚
â”‚       Ù¾Ø´ØªÛŒØ¨Ø§Ù†: Ø³Ù„Ø§Ù…ØŒ Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù…  â”‚
â”‚                         Ú©Ù…Ú© Ú©Ù†Ù…ØŸ   â”‚
â”‚                            10:32   â”‚
â”‚                                    â”‚
â”‚  Ø´Ù…Ø§: ...                          â”‚
â”‚                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [_________________] [Ø§Ø±Ø³Ø§Ù„]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯!
```

### ğŸ’» Ù…Ø«Ø§Ù„ Ú©Ø¯: Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ù…Ù‡Ù…Ø§Ù†

```typescript
// app/api/support/tickets/route.ts
export async function POST(req: NextRequest) {
  const body = await req.json();
  const { workspaceId, subject, guestInfo } = body;

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ IP
  const ip =
    req.headers.get("x-forwarded-for")?.split(",")[0] ||
    req.headers.get("x-real-ip") ||
    "unknown";

  // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ø§Ø² Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ Ø¯ÛŒØªØ§Ø¨ÛŒØ³)
  const geoData = await fetch(`https://ipapi.co/${ip}/json/`)
    .then((r) => r.json())
    .catch(() => ({}));

  // Parse User-Agent
  const userAgent = req.headers.get("user-agent") || "";
  const parsed = parseUserAgent(userAgent);

  return prisma.$transaction(async (tx) => {
    // 1. Ø¬Ø³ØªØ¬Ùˆ ÛŒØ§ Ø³Ø§Ø®Øª Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†
    let guestUser = await tx.supportGuestUser.findFirst({
      where: {
        workspaceId,
        ipAddress: ip,
        fingerprint: guestInfo.fingerprint,
      },
    });

    if (!guestUser) {
      guestUser = await tx.supportGuestUser.create({
        data: {
          workspaceId,
          ipAddress: ip,
          country: geoData.country_name,
          city: geoData.city,
          userAgent,
          browser: parsed.browser,
          os: parsed.os,
          device: parsed.device,
          fingerprint: guestInfo.fingerprint,
          sessionId: generateSessionId(),
          visitCount: 1,
        },
      });
    } else {
      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
      await tx.supportGuestUser.update({
        where: { id: guestUser.id },
        data: {
          lastVisitAt: new Date(),
          visitCount: { increment: 1 },
        },
      });
    }

    // 2. Ø³Ø§Ø®Øª Ø´Ù…Ø§Ø±Ù‡ ØªÛŒÚ©Øª
    const ticketNumber = await generateTicketNumber(tx, workspaceId);

    // 3. Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª
    const ticket = await tx.supportTicket.create({
      data: {
        workspaceId,
        ticketNumber,
        subject,
        guestUserId: guestUser.id,
        priority: "MEDIUM",
        status: "OPEN",
      },
      include: {
        guestUser: true,
      },
    });

    // 4. Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
    await tx.supportMessage.create({
      data: {
        ticketId: ticket.id,
        body: `ØªÛŒÚ©Øª ${ticketNumber} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯. Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÛŒÚ© Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù¾Ø§Ø³Ø® Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø¯.`,
        messageType: "SYSTEM",
        isInternal: false,
      },
    });

    // 5. Ø«Ø¨Øª ØªØ§Ø±ÛŒØ®Ú†Ù‡
    await tx.supportTicketHistory.create({
      data: {
        ticketId: ticket.id,
        action: "CREATED",
        note: `ØªÛŒÚ©Øª ØªÙˆØ³Ø· Ù…Ù‡Ù…Ø§Ù† (IP: ${ip}) Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`,
      },
    });

    return Response.json({ ticket });
  });
}

// Helper: ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ ØªÛŒÚ©Øª
async function generateTicketNumber(
  tx: any,
  workspaceId: number
): Promise<string> {
  const year = new Date().getFullYear();
  const count = await tx.supportTicket.count({
    where: {
      workspaceId,
      createdAt: {
        gte: new Date(`${year}-01-01`),
        lt: new Date(`${year + 1}-01-01`),
      },
    },
  });

  const number = (count + 1).toString().padStart(5, "0");
  return `TKT-${year}-${number}`;
}

// Helper: Parse User-Agent
function parseUserAgent(ua: string) {
  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ua-parser-js
  const UAParser = require("ua-parser-js");
  const parser = new UAParser(ua);

  return {
    browser: `${parser.getBrowser().name} ${parser.getBrowser().version}`,
    os: `${parser.getOS().name} ${parser.getOS().version}`,
    device: parser.getDevice().type || "desktop",
  };
}
```

---

## âš–ï¸ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ

| ÙˆÛŒÚ˜Ú¯ÛŒ             | ğŸ¢ Internal Chat             | ğŸ« Support Chat                    |
| ----------------- | ---------------------------- | ---------------------------------- |
| **Ù‡Ø¯Ù**           | Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¯Ø±ÙˆÙ† ØªÛŒÙ…ÛŒ             | Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø´ØªØ±ÛŒ                     |
| **Ú©Ø§Ø±Ø¨Ø±Ø§Ù†**       | ÙÙ‚Ø· Admin                    | Admin + Guest + User               |
| **Ø¯Ø³ØªØ±Ø³ÛŒ**        | Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ WorkspaceUser       | Ø¹Ù…ÙˆÙ…ÛŒ (ÙˆØ¨Ø³Ø§ÛŒØª)                     |
| **Ø³Ø§Ø®ØªØ§Ø±**        | Ø§ØªØ§Ù‚ Ù…Ø­ÙˆØ± (Room-based)       | ØªÛŒÚ©Øª Ù…Ø­ÙˆØ± (Ticket-based)           |
| **Real-time**     | Ø¨Ù„Ù‡ (Socket.io)              | Ø§Ø®ØªÛŒØ§Ø±ÛŒ                            |
| **ØªØ®ØµÛŒØµ**         | Ø®ÙˆØ¯Ú©Ø§Ø± (ØªÛŒÙ…/Ù¾Ø±ÙˆÚ˜Ù‡)           | Ø¯Ø³ØªÛŒ (Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†)                  |
| **SLA**           | Ø®ÛŒØ±                          | Ø¨Ù„Ù‡ (responseTime, resolutionTime) |
| **Ø§ÙˆÙ„ÙˆÛŒØª**        | Ø®ÛŒØ±                          | Ø¨Ù„Ù‡ (LOW â†’ CRITICAL)               |
| **ÙˆØ¶Ø¹ÛŒØª**         | ÙØ¹Ø§Ù„/Ø¢Ø±Ø´ÛŒÙˆ                   | OPEN â†’ CLOSED (7 Ø­Ø§Ù„Øª)             |
| **Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ**    | Ø®ÛŒØ±                          | Ø¨Ù„Ù‡ (isInternal)                   |
| **Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…Ù‡Ù…Ø§Ù†** | Ù†Ø§Ù…Ø±Ø¨ÙˆØ·                      | Ø¨Ù„Ù‡ (IP, Geo, Browser)             |
| **ØªØ§Ø±ÛŒØ®Ú†Ù‡**       | ÙÙ‚Ø· Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§                  | ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ ØªØºÛŒÛŒØ±Ø§Øª               |
| **Ù„ÛŒÙ†Ú© Ù…Ù†Ø§Ø¨Ø¹**    | Ø¨Ù„Ù‡ (Docs, Tasks, Knowledge) | Ø¨Ù„Ù‡ (+ ØªØ®ØµÛŒØµ ÙˆØ¸ÛŒÙÙ‡ Ø¨Ù‡ Dev)         |
| **UI Location**   | `/dashboard/chat`            | `/dashboard/support`               |

---

## ğŸ–¥ï¸ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯

### Ø³Ø§Ø®ØªØ§Ø± ÙÙˆÙ„Ø¯Ø±Ù‡Ø§

```
src/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ internal-chat/           âœ… Ù…Ø§Ú˜ÙˆÙ„ Ú†Øª Ø¯Ø±ÙˆÙ† Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts         â†’ GET/POST /api/internal-chat
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ messages/route.ts
â”‚   â”‚   â”‚   â””â”€â”€ rooms/[roomId]/resources/route.ts
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatRoomList.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatInterface.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RoomHeader.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageList.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageInput.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ResourceTabs.tsx  (Documents/Tasks/Knowledge)
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â””â”€â”€ useInternalChat.ts
â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â””â”€â”€ InternalChatService.ts
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ views/
â”‚   â”‚       â””â”€â”€ page.tsx         â†’ /dashboard/chat
â”‚   â”‚
â”‚   â””â”€â”€ support/                  âœ… Ù…Ø§Ú˜ÙˆÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
â”‚       â”œâ”€â”€ api/
â”‚       â”‚   â”œâ”€â”€ tickets/
â”‚       â”‚   â”‚   â”œâ”€â”€ route.ts     â†’ GET/POST /api/support/tickets
â”‚       â”‚   â”‚   â””â”€â”€ [id]/
â”‚       â”‚   â”‚       â”œâ”€â”€ route.ts
â”‚       â”‚   â”‚       â”œâ”€â”€ messages/route.ts
â”‚       â”‚   â”‚       â”œâ”€â”€ assign/route.ts
â”‚       â”‚   â”‚       â””â”€â”€ status/route.ts
â”‚       â”‚   â”œâ”€â”€ categories/route.ts
â”‚       â”‚   â””â”€â”€ labels/route.ts
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ admin/
â”‚       â”‚   â”‚   â”œâ”€â”€ TicketList.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ TicketDetail.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ CustomerInfo.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ MessageThread.tsx
â”‚       â”‚   â”‚   â””â”€â”€ InternalNoteEditor.tsx
â”‚       â”‚   â””â”€â”€ public/
â”‚       â”‚       â”œâ”€â”€ SupportWidget.tsx    (Ø¨Ø±Ø§ÛŒ ÙˆØ¨Ø³Ø§ÛŒØª)
â”‚       â”‚       â””â”€â”€ TicketStatus.tsx
â”‚       â”œâ”€â”€ hooks/
â”‚       â”‚   â”œâ”€â”€ useSupport.ts
â”‚       â”‚   â””â”€â”€ useSupportTicket.ts
â”‚       â”œâ”€â”€ service/
â”‚       â”‚   â””â”€â”€ SupportService.ts
â”‚       â”œâ”€â”€ types/
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â””â”€â”€ views/
â”‚           â”œâ”€â”€ admin/
â”‚           â”‚   â””â”€â”€ page.tsx      â†’ /dashboard/support
â”‚           â””â”€â”€ public/
â”‚               â””â”€â”€ page.tsx      â†’ /[slug]/support
```

### Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯

```typescript
// lib/data.tsx

export const adminMenuItems = [
  // ... existing items

  // Ø¨Ø®Ø´ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª
  {
    id: "chat",
    label: "Ú†Øª ØªÛŒÙ…ÛŒ",
    icon: <DIcon icon="fa-comments" />,
    href: "/dashboard/chat",
  },
  {
    id: "support",
    label: "Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†",
    icon: <DIcon icon="fa-headset" />,
    href: "/dashboard/support",
    badge: unreadTicketsCount, // ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡
  },
];
```

---

## ğŸ”Œ API Routes

### Internal Chat

```
GET    /api/internal-chat                      â†’ Ù„ÛŒØ³Øª Ø§ØªØ§Ù‚â€ŒÙ‡Ø§
POST   /api/internal-chat                      â†’ Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚
GET    /api/internal-chat/[id]                 â†’ Ø¬Ø²Ø¦ÛŒØ§Øª Ø§ØªØ§Ù‚
PATCH  /api/internal-chat/[id]                 â†’ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§ØªØ§Ù‚
DELETE /api/internal-chat/[id]                 â†’ Ø­Ø°Ù Ø§ØªØ§Ù‚

GET    /api/internal-chat/[id]/messages        â†’ Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
POST   /api/internal-chat/[id]/messages        â†’ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
PATCH  /api/internal-chat/[id]/messages/[msgId] â†’ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
DELETE /api/internal-chat/[id]/messages/[msgId] â†’ Ø­Ø°Ù Ù¾ÛŒØ§Ù…

GET    /api/internal-chat/[id]/members         â†’ Ù„ÛŒØ³Øª Ø§Ø¹Ø¶Ø§
POST   /api/internal-chat/[id]/members         â†’ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ø¶Ùˆ
DELETE /api/internal-chat/[id]/members/[userId] â†’ Ø­Ø°Ù Ø¹Ø¶Ùˆ

GET    /api/internal-chat/[id]/resources       â†’ Ù…Ù†Ø§Ø¨Ø¹ Ø§ØªØ§Ù‚ (Docs/Tasks/Knowledge)
POST   /api/internal-chat/[id]/resources/documents â†’ Ù„ÛŒÙ†Ú© Ø³Ù†Ø¯
POST   /api/internal-chat/[id]/resources/tasks â†’ Ù„ÛŒÙ†Ú© ÙˆØ¸ÛŒÙÙ‡
POST   /api/internal-chat/[id]/resources/knowledge â†’ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ø´
```

### Support Chat

```
GET    /api/support/tickets                    â†’ Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
POST   /api/support/tickets                    â†’ Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª
GET    /api/support/tickets/[id]               â†’ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª
PATCH  /api/support/tickets/[id]               â†’ ÙˆÛŒØ±Ø§ÛŒØ´ ØªÛŒÚ©Øª
DELETE /api/support/tickets/[id]               â†’ Ø­Ø°Ù ØªÛŒÚ©Øª

GET    /api/support/tickets/[id]/messages      â†’ Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
POST   /api/support/tickets/[id]/messages      â†’ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
POST   /api/support/tickets/[id]/messages/internal â†’ Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø®ØµÙˆØµÛŒ

POST   /api/support/tickets/[id]/assign        â†’ ØªØ®ØµÛŒØµ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
PATCH  /api/support/tickets/[id]/status        â†’ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
PATCH  /api/support/tickets/[id]/priority      â†’ ØªØºÛŒÛŒØ± Ø§ÙˆÙ„ÙˆÛŒØª

GET    /api/support/tickets/[id]/history       â†’ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
GET    /api/support/tickets/[id]/resources     â†’ Ù…Ù†Ø§Ø¨Ø¹ Ù„ÛŒÙ†Ú© Ø´Ø¯Ù‡

GET    /api/support/categories                 â†’ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
GET    /api/support/labels                     â†’ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§

GET    /api/support/stats                      â†’ Ø¢Ù…Ø§Ø± (ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡/...)
```

---

## ğŸ’¡ Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ

### 1. Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ù¾Ø±ÙˆÚ˜Ù‡ + Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… + Ù„ÛŒÙ†Ú© Ø³Ù†Ø¯

```typescript
async function setupProjectChat(projectId: number) {
  // 1. Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚
  const room = await fetch("/api/internal-chat", {
    method: "POST",
    body: JSON.stringify({
      type: "PROJECT",
      projectId,
      title: "Ù¾Ø±ÙˆÚ˜Ù‡ CRM",
      description: "Ú¯ÙØªÚ¯Ùˆ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ CRM",
    }),
  }).then((r) => r.json());

  // 2. Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
  await fetch(`/api/internal-chat/${room.id}/messages`, {
    method: "POST",
    body: JSON.stringify({
      body: "Ø³Ù„Ø§Ù… ØªÛŒÙ…! Ø§ÛŒÙ† Ø§ØªØ§Ù‚ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ CRM Ø§Ø³Øª.",
      messageType: "TEXT",
    }),
  });

  // 3. Ù„ÛŒÙ†Ú© Ø³Ù†Ø¯ Ø¨Ù‡ Ø§ØªØ§Ù‚
  await fetch(`/api/internal-chat/${room.id}/resources/documents`, {
    method: "POST",
    body: JSON.stringify({
      documentId: 50,
      isPinned: true,
      note: "Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù¾Ø±ÙˆÚ˜Ù‡",
    }),
  });

  return room;
}
```

### 2. Ù¾Ø§Ø³Ø® Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ù‡ ØªÛŒÚ©Øª + Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø®ØµÙˆØµÛŒ

```typescript
async function respondToTicket(ticketId: number) {
  // 1. Ù¾Ø§Ø³Ø® Ø¹Ù…ÙˆÙ…ÛŒ (Ù…Ø´ØªØ±ÛŒ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ø¯)
  await fetch(`/api/support/tickets/${ticketId}/messages`, {
    method: "POST",
    body: JSON.stringify({
      body: "Ø³Ù„Ø§Ù…ØŒ Ù…Ø´Ú©Ù„ Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù…. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.",
      messageType: "TEXT",
      isInternal: false,
    }),
  });

  // 2. ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø®ØµÙˆØµÛŒ (ÙÙ‚Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯)
  await fetch(`/api/support/tickets/${ticketId}/messages/internal`, {
    method: "POST",
    body: JSON.stringify({
      body: "Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ù‡Ù… Ù…Ø´Ú©Ù„ Ù…Ø´Ø§Ø¨Ù‡ Ø¯Ø§Ø´ØªÙ‡. Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØªÛŒÙ… Dev Ø§Ø·Ù„Ø§Ø¹ Ø¯Ù‡ÛŒÙ….",
      messageType: "NOTE",
    }),
  });

  // 3. Ù„ÛŒÙ†Ú© Ø¨Ù‡ ÙˆØ¸ÛŒÙÙ‡
  await fetch(`/api/support/tickets/${ticketId}/resources/tasks`, {
    method: "POST",
    body: JSON.stringify({
      taskId: 123, // ÙˆØ¸ÛŒÙÙ‡ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Dev
      note: "Ø±ÙØ¹ Ø¨Ø§Ú¯ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† ØªÛŒÚ©Øª",
    }),
  });

  // 4. ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
  await fetch(`/api/support/tickets/${ticketId}/status`, {
    method: "PATCH",
    body: JSON.stringify({
      status: "WAITING", // Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ù…Ø´ØªØ±ÛŒ
      note: "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ØŒ Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù…Ø´ØªØ±ÛŒ",
    }),
  });
}
```

### 3. Ø¯Ø±ÛŒØ§ÙØª Ù…Ù†Ø§Ø¨Ø¹ ÛŒÚ© Ø§ØªØ§Ù‚ (Documents + Tasks + Knowledge)

```typescript
async function getChatRoomResources(
  roomId: number,
  includeProject: boolean = true
) {
  const response = await fetch(
    `/api/internal-chat/${roomId}/resources?includeProject=${includeProject}`
  );

  const data = await response.json();

  return {
    documents: {
      total: data.documents.length,
      pinned: data.documents.filter((d: any) => d.isPinned),
      items: data.documents,
    },
    tasks: {
      total: data.tasks.length,
      pending: data.tasks.filter((t: any) => t.status.name === "Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…"),
      items: data.tasks,
    },
    knowledge: {
      total: data.knowledge.length,
      items: data.knowledge,
    },
  };
}

// Ø§Ø³ØªÙØ§Ø¯Ù‡:
const resources = await getChatRoomResources(123, true);

console.log(`Ø§Ø³Ù†Ø§Ø¯: ${resources.documents.total}`);
console.log(`ÙˆØ¸Ø§ÛŒÙ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…: ${resources.tasks.pending.length}`);
console.log(`Ù…Ù‚Ø§Ù„Ø§Øª Ø¯Ø§Ù†Ø´: ${resources.knowledge.total}`);
```

---

## ğŸ¯ Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ

### 1. Ø§Ù…Ù†ÛŒØª

```typescript
// Ù‡Ù…ÛŒØ´Ù‡ workspaceId Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯
async function checkAccess(
  roomId: number,
  userId: number,
  workspaceId: number
) {
  const room = await prisma.chatRoom.findFirst({
    where: {
      id: roomId,
      workspaceId, // âœ… Workspace Isolation
      members: {
        some: {
          workspaceUserId: userId, // âœ… Ø¹Ø¶ÙˆÛŒØª
          leftAt: null, // âœ… Ù‡Ù†ÙˆØ² Ø¹Ø¶Ùˆ Ø§Ø³Øª
        },
      },
    },
  });

  if (!room) {
    throw new ForbiddenException("Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²");
  }

  return room;
}
```

### 2. Real-time (Socket.io)

```typescript
// pages/api/socket.ts
import { Server } from "socket.io";

export default function handler(req: any, res: any) {
  if (res.socket.server.io) {
    return res.end();
  }

  const io = new Server(res.socket.server);
  res.socket.server.io = io;

  io.on("connection", (socket) => {
    console.log("User connected:", socket.id);

    // Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø§ØªØ§Ù‚
    socket.on("join-room", (roomId: number) => {
      socket.join(`room-${roomId}`);
    });

    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
    socket.on("send-message", async (data) => {
      const { roomId, message } = data;

      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
      const savedMessage = await prisma.chatMessage.create({
        data: message,
      });

      // Ø§Ø±Ø³Ø§Ù„ real-time Ø¨Ù‡ Ù‡Ù…Ù‡ Ø§Ø¹Ø¶Ø§ÛŒ Ø§ØªØ§Ù‚
      io.to(`room-${roomId}`).emit("new-message", savedMessage);
    });
  });

  return res.end();
}
```

### 3. Pagination

```typescript
// Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ù†Ù…Ø§ÛŒØ´ Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…)
async function getMessages(
  roomId: number,
  page: number = 1,
  limit: number = 50
) {
  const messages = await prisma.chatMessage.findMany({
    where: { roomId },
    orderBy: { createdAt: "desc" },
    skip: (page - 1) * limit,
    take: limit,
    include: {
      sender: {
        select: {
          displayName: true,
          user: { select: { name: true } },
        },
      },
    },
  });

  // Ù…Ø¹Ú©ÙˆØ³ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ (Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ø¯Ø± Ø¨Ø§Ù„Ø§)
  return messages.reverse();
}
```

---

## ğŸ“š Ù…Ù†Ø§Ø¨Ø¹ Ø§Ø¶Ø§ÙÛŒ

- [Schema Ú©Ø§Ù…Ù„ - V2](./chat-schema-proposal-v2.prisma)
- [Ù…Ù‚Ø§ÛŒØ³Ù‡ Schema Ù‚Ø¯ÛŒÙ… Ùˆ Ø¬Ø¯ÛŒØ¯](./chat-schema-comparison.md)
- [Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡](./chat-schema-examples.md)

---

**Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯! ğŸš€**
